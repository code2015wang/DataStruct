# 实战java虚拟机 ---jvm故障诊断与性能优化

## 初探java虚拟机

​     所谓虚拟机，就是一台虚拟的计算机。它是一款软件，用来执行虚拟计算机指令。大体上虚拟机可以分为系统虚拟机和程序虚拟机。程序虚拟机的典型代表是java虚拟机，它专门用来执行单个计算机程序而设计，在java中执行的指令我们称为java字节码指令。hotspot虚拟机

java虚拟机规范的主要内容大概有以下几个部分：

1. 定义虚拟机的内部结构
2. 定义虚拟机执行的字节码类型和功能
3. 定义了class文件的结构
4. 定义了类的加载、连接和初始化

所谓原码就是符号位加上数字的二进制表示;反码就是在原码的基础上，符号位不变，其余位取反;补码：正数的补码是原码，负数的补码是反码加1.

## 认识java虚拟机的基本结构

![1482221955283191](/down/DataStruct/1482221955283191.png)

类加载子系统负责从文件系统或者网络中加载class信息，加载的类信息存放在一块称为方法区的内存空间。除了类的信息外，方法区可能还会存放运行时常量池的信息，包括字符串字面量和数字常量。

java堆在虚拟机启动的时候建立，它是java程序最主要的内存工作区域。几乎所有java对象的实例都放在java堆里。堆空间是所有线程共享。

java的NIO库允许java程序程序使用直接内存。直接内存是在java堆外、直接向系统申请的内存空间。通常，访问直接内存的速度会优于java堆。因此出于性能考虑，读写频繁的场合可能会考虑使用直接内存。

垃圾回收机制是java虚拟机的重要组成部分，垃圾回收器可以对方法区、java堆和直接内存进行回收。其中java堆是垃圾回收器的工作重点。垃圾回收系统会在后台默默工作，默默查找、标识并释放垃圾对象，完成包括java堆、方法区和直接内存中的全自动化管理。

每一个java虚拟机线程都有一个私有的java栈，一个线程的java栈在线程创建的时候被创建。java栈中保存局部变量、方法参数，同时和java方法的调用、返回密切相关。

本地方法栈和java栈类似，但java栈用于java方法，而本地栈用于本地方法调用。作为对java虚拟机的重要扩展，java虚拟机允许java直接调用本地方法。

PC寄存器也是每一个线程的私有空间，java虚拟机会为每个java线程创建PC寄存器。

执行引擎是java虚拟机的最核心组件之一，它负责执行虚拟机的字节码

###  设置java虚拟机参数

java虚拟机可以使用java来启动，java的命令行使用方法如下：

java [-option] calss [args....]

其中 ，-option 表示java虚拟机启动的参数，class为带有main（）函数的java类 ，args表示传递给主函数main（）的参数。

-Xmx 32m 指定系统最大可用堆空间为32MB

-Xss 来指定线程最大栈空间

程序如何调用：出入java栈。java栈是一块线程私有的内存空间。线程的基本行为是函数调用，每次函数调用都是通过java栈传递的。在java栈中包存的主要内容是栈帧。栈帧主要由局部变量表、操作数栈和帧数据区。局部变量是栈帧的主要组成部分之一，它用于保存函数的参数以及局部变量。局部变量表中变量只对当前函数有效，当函数数调用结束后，随着函数的栈帧销毁，局部变量表随之销毁。操作数栈，主要用于保存计算过程中的中间结果，同时作为计算过程中变量临时存储空间。帧数据区中保存着访问常量池的指针，方便程序访问常量池。

方法区用于保存系统的类信息，比如类的字段、方法、常量池等。方法区的大小决定了系统可以保存多少个类。如果系统定义了太多的类，导致方法区溢出，虚拟机同样会抛出内存溢出错误。

## 常用java虚拟机参数

### 掌握跟踪调试参数

1. 跟踪垃圾回收-----读懂虚拟机日志

最简单的一个GC参数是 -XX：+PrintGC，使用这个参数后启动java虚拟机后，只要遇到GC就会打印日志。

如果需要更加详细的信息，则可以使用-XX：+PrintGCDetails参数

如果需要更全面的信息，我们可以使用 -XX：+PrintHeapAtGC。它会在每次GC前后分别每次打印堆信息。

如果分析GC发生的时间，还可以使用-XX:+PrintGCTimeStamp，该参数会在GC时，额外输出GC发生的时间，该输出时间为虚拟机启动后的时间偏移量。

2. 类加载/卸载的跟踪

java程序的运行离不开类，为了更好的理解程序，有时候需要知道程序加载了那些类。随着动态代理、AOP技术的普遍使用，系统由可能也极有可能在运行时动态生成某些类，这些类比较隐蔽，无法通过文件系统找到，为此虚拟机提供了类加载/卸载跟踪参数就显得格外有意义。

可以使用参数-verbose:class 跟踪类的加载/卸载。也可以单独使用参数 -XX:+TraceClassLoading跟踪类的加载，使用参数-XX:+TraceClassUnloading跟踪类的卸载。

3. 系统参数查看

参数-XX:PrintVMOptions可以在程序运行时，打印虚拟机接受的命令行显式参数

### 让性能飞起来：学习堆的配置参数

1. 最大堆和初始堆的设置

当java进程启动时，虚拟机就会分配一块初始堆空间，可以使用参数 -Xms 指定这块堆空间的大小，最大堆空间可以使用-Xmx指定。

### client和server二选一：虚拟机的工作模式

目前虚拟机支持Client和Server两种运行模式。使用参数-client可以指定使用Client模式。使用参数-seerver可以指定使用Server模式。与client模式相比，server模式启动比较慢，但系统完全启动并进入稳定1期server模式的执行速度远远快于client模式。因此，对于后台运行时间长的应用，使用server模式更合适。

### JDK性能监控工具

1. 查看java进程----jps命令

命令jps用于列出java进程。直接运行jps命令不加任何参数，可以列出java进程ID以及main函数的短名称。

-p 只输出进程id，而不输出类的短名称

-m 可以输出传递给java进程（主函数）的参数

-l  可以列出主函数的完整路径

-v 显示传递给java虚拟机的参数

2. 查看虚拟机运行时的信息--jstat命令

jsata是一个可以查看java程序运行时相关信息的工具，它功能非常强大，可以通过它查看堆的信息的详细情况。它的基本语法如下：

```
jstat -<option> [-t] [-h ] <vmid> [< interval > [<count >]]
```















